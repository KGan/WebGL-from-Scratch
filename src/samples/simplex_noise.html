<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<!--

Simplex Noise on Canvas
=======================

[Wikipedia]:
_"Simplex noise is a method for constructing an n-dimensional noise function comparable to Perlin noise ("classic" noise) but with a lower computational overhead, especially in larger dimensions. Ken Perlin designed the algorithm in 2001[1] to address the limitations of his classic noise function, especially in higher dimensions."_

  [Wikipedia]: http://en.wikipedia.org/wiki/Simplex_noise


Abstact
-------

Cover a surface with organic-looking noise. We are only aiming for 2D noise
here, though the principle is the same, other dimensions are to come later.


High level
----------

Consider the surface to be covered with equilateral triangles (with all sides of
same length) and have each corner point have a random influence. Let us have
each corner point represented by a black and white linear gradient. Of course,
each corner only affects the pixels close to it.

For mathematical simplicity, we will make the triangles so that their sides
together make 45 degree lines. See the sample or [Simplex Noise Demystified]
for a graphical representation.  


Technical
---------

For setup we will create a random set of corner points. We don't want
them to change in the middle of rendering.

Then for each pixel we do the following:

  1.  Scale the pixel to create an effect of wanted dimensions.
  2.  Skew the pixel onto the rectangular grid.
  3.  See on which tile it lands.
  4.  Each tile is two triangles, figure out on which of the triangles it landed.
  5.  Skew back onto the triangular grid.
  6.  Get the gradients for all corner points of this triangle.
  7.  Calculate and add the effects the cornerts points have on this pixel.
  8.  Return the value between -1 and 1.


For more theory, see [Ken Perlin's original paper] or [Simplex Noise Demystified] by Stefan Gustavson.

  [Ken Perlin's original paper]: http://staffwww.itn.liu.se/~stegu/simplexnoise/simplexnoise.pdf
  [Simplex Noise Demystified]: http://www.google.co.uk/url?sa=t&rct=j&q=simplex%20noise&source=web&cd=7&ved=0CEUQFjAG&url=http%3A%2F%2Fwww.itn.liu.se%2F~stegu%2Fsimplexnoise%2Fsimplexnoise.pdf&ei=Xs9AT83iEcSp0QW5wfmODw&usg=AFQjCNEVzOM03haFrTgLrjJp-jPkQyTOKA

 -->
<html>
<head>
<title>Simplex Noise 2D on Canvas</title>
<link href="assets/style.css" rel="stylesheet" type="text/css">
<script src="../js/namespace.js" type="text/javascript"></script>
<script src="assets/simplexNoise2D.js" type="text/javascript"></script>
<script type="text/javascript">

    /**
     * Show results
     * ------------
     *
     * Initialize a 2D canvas and use the function defined in
     * timotuominen.webgl.canvasGeneratorFunction to fill the screen.
     *
     * The timeout is a workaround for a strange "INDEX_SIZE_ERR: DOM Exception 1"
     * but that happened only the first time the full screen link was opened.
     *
     */

    function drawStatus (ctx, text) {
        ctx.font = "14px Arial";
        ctx.fillStyle = "black";
        ctx.fillText(text, 16, 21);
        ctx.fillStyle = "white";
        ctx.fillText(text, 15, 20);
    }

    function fillWith2DNoise (canvas, kernel, scale) {
        var generator = new timotuominen.webgl.simplexNoise.SimplexNoise2D({
            gradientKernel: kernel
        });
        var w = canvas.width, h = canvas.height, ctx = canvas.getContext("2d");
        var imgData = ctx.createImageData(w, h);
        for (var x = 0; x < w; x++) {
            for (var y = 0; y < h; y++) {
                var idx = (x + y * w) * 4;
                var c = (generator.processPixel(x*scale, y*scale) + 1)*128;
                imgData.data[idx+0] = imgData.data[idx+1] = imgData.data[idx+2] = c;
                imgData.data[idx+3] = 255;
            }
        }
        ctx.putImageData(imgData, 0, 0);
        drawStatus(ctx, "Plain noise at " + 1/scale + "x");
    }

    function fillWithSurflets (canvas, kernel, scale) {
        var generator = new timotuominen.webgl.simplexNoise.SimplexNoise2D({
            gradientKernel: kernel,
            triangleHeightSquared: .24
        });
        var w = canvas.width, h = canvas.height, ctx = canvas.getContext("2d");
        var imgData = ctx.createImageData(w, h);
        for (var x = 0; x < w; x++) {
            for (var y = 0; y < h; y++) {
                var idx = (x + y * w) * 4;
                var c = (generator.processPixel(x*scale, y*scale)*100 + 1)*128;
                imgData.data[idx+0] = imgData.data[idx+1] = imgData.data[idx+2] = c;
                imgData.data[idx + 3] = 255;
            }
        }
        ctx.putImageData(imgData, 0, 0);
        drawStatus(ctx, "Surflets that make up the noise");
    }

    function fillWithFractal (canvas, kernel, scale, passes) {
        passes = passes || 10;
        var generator = new timotuominen.webgl.simplexNoise.SimplexNoise2D({
            gradientKernel: kernel
        });
        var w = canvas.width, h = canvas.height, ctx = canvas.getContext("2d");
        var imgData = ctx.createImageData(w, h);
        for (var x = 0; x < w; x++) {
            for (var y = 0; y < h; y++) {
                var idx = (x + y * w) * 4;
                var c = 0;
                for (var i = 0; i < passes; i++) {
                    var s = Math.pow(2, i);
                    c += (generator.processPixel(x*s*scale, y*s*scale) + 1)*64/s;
                }
                imgData.data[idx+0] = imgData.data[idx+1] = imgData.data[idx+2] = c;
                imgData.data[idx + 3] = 255;
            }
        }
        ctx.putImageData(imgData, 0, 0);
        drawStatus(ctx, "With " + passes + " fractal passes");
    }

    function initialize () {
        var scale = .005;
        var gradientKernel = new timotuominen.webgl.simplexNoise.GradientKernel();

        var canvases = [], NUM_CANVASES = 3;
        for (var i = 0; i < NUM_CANVASES; i++) {
            var canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            canvases.push(canvas);
        }

        function draw () {
            var w = window.innerWidth;
            var h = window.innerHeight;
            canvases[0].width = canvases[1].width = canvases[2].width = w/3;
            canvases[0].height = canvases[1].height = canvases[2].height = h;
            fillWith2DNoise(canvases[0], gradientKernel, scale);
            fillWithSurflets(canvases[1], gradientKernel, scale);
            fillWithFractal(canvases[2], gradientKernel, scale);
        }

        window.onresize = draw;
        draw();
    }


</script>
</head>
<body onload="setTimeout(initialize, 15)">
    <a id="main-link" href="../explain.html#simplex_noise">Explain</a>
    <script type="text/javascript">
        if (window.location.hash === "#thumbnail") { document.getElementById("main-link").style.display = "none"; }
    </script>
</body>
</html>
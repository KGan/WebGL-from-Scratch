<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>WebGL from Scratch</title>
<link href="style.css" rel="stylesheet" type="text/css">

<script id="vs-shader" type="x-shader/x-vertex">

attribute vec4 position;

void main(void) {
    gl_Position = position;
}

</script>

<script id="fs-shader" type="x-shader/x-fragment">

#ifdef GL_ES
precision highp float;
#endif

// Define a class for our particles. This is a C-style struct.
struct Particle
{
    // xy screen coordinate of the particle.
    vec2 pos;

    // Progress of this particle, from 1.0 to 0.0. After it reaches 0, it is deleted.
    float life;

    // Size relative to other particles. Does not necessarily imply absolute screen size.
    float size;
};

uniform sampler2D tex0;
uniform float time;
uniform vec2 resolution;
uniform Particle particles[128];

// xy vector that ideally has the length of 1.0.
uniform vec2 lightDirection;

float calculateInfluence(Particle p, vec2 coord, out vec2 normal)
{
    float life = pow(p.life,3.);

    vec2 dv = p.pos-coord;
    float d = length(dv);
    normal = dv/d;

    float r = 20.*(1.-life)*p.size;
    float ratio = d/r;
    

    float theta = 20.*pow(d,1.4)/(6.*r);
    float thetaOffset = -1.6+2.*life*ratio-.5*pow(life,2.);
    float fade = (1.-pow(ratio,2.))*pow(life,3.);
    return d < r ? cos(theta+thetaOffset)*fade : 0.;
}

vec4 dodge(vec4 bottom, vec4 top)
{
    return vec4(bottom.xyz/(vec3(1.)-top.xyz),1.);
}

void main(void)
{
    vec2 coord = vec2(gl_FragCoord.x,resolution.y-gl_FragCoord.y);
    vec2 uv = coord/resolution;

    vec3 color = vec3(0.);
    float light = 0.;
    for (int i = 0; i < 32; i++) {
        Particle particle = particles[i];
        if (particle.life > 0.) {
            vec2 normal;
            float f = calculateInfluence(particle, coord, normal);
            uv += .07*normal*f;
            light += clamp(f*(normal.x*-lightDirection.x+normal.y*-lightDirection.y),0.,.6);
        }
    }

    vec4 texColor = texture2D(tex0,uv);
    gl_FragColor = dodge(vec4(texColor.xyz,1.),vec4(clamp(pow(light,2.),0.,1.)));
}

</script>

<script type="text/javascript">

    window.timotuominen = { webgl: {} };

    timotuominen.webgl.FromScratchDemo = function (options) {
        var particleRenderer = new timotuominen.webgl.PlainShader(options);
        var render = particleRenderer.render;
        var prepareShader = particleRenderer.prepareShader;

        var NUM_MAX_PARTICLES = 128;
        var particles = new Array(NUM_MAX_PARTICLES);

        function updateParticles () {
            for (var i = 0; i < NUM_MAX_PARTICLES; i++) {
                if (particles[i]) {
                    var p = particles[i];
                    if (p.life > 0) {
                        p.life -= .004;
                        if (p.life <= .01) {
                            p.life = 0;
                        }
                    } else {
                        particles[i] = null;
                    }
                }
            }
        }

        function addParticle (particle) {
            for (var i = 0; i < NUM_MAX_PARTICLES; i++) {
                if (!particles[i]) {
                    particles[i] = particle;
                    return;
                }
            }
        }

        particleRenderer.render = function () {
            if (Math.random() < .08) {
                addParticle({
                    life: 1.,
                    x: Math.random()*this.viewportWidth,
                    y: Math.random()*this.viewportHeight,
                    size: 60.+Math.random()*30.
                });
            }
            updateParticles();
            render.apply(this);
        };

        particleRenderer.prepareShader = function () {
            prepareShader.apply(this);
            this.gl.uniform2f(this.getUni("lightDirection"), Math.sqrt(2), Math.sqrt(2));
            for (var i = 0; i < NUM_MAX_PARTICLES; i++) {
                if (particles[i]) {
                    var p = particles[i];
                    this.gl.uniform2f(this.getUni("particles["+i+"].pos"), p.x, p.y);
                    this.gl.uniform1f(this.getUni("particles["+i+"].life"), p.life);
                    this.gl.uniform1f(this.getUni("particles["+i+"].size"), p.size);
                }
            }
        };

        return particleRenderer;
    };

</script>

<script src="plainShader.js"></script>
<script src="webglUtils.js"></script>
<script src="canvasInitialize.js"></script>

</head>
<body>
    <a id="back-link" href="../index.html">Back to Index</a>
    <!--

    This not nicely formatted yet, disable for now :)

    <a id="main-link" href="../explain.html#particle_ripple">Show formatted source</a>

    -->
</body>
</html>
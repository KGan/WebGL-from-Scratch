<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>WebGL from Scratch</title>
<link href="style.css" rel="stylesheet" type="text/css">

<script id="vs-shader" type="x-shader/x-vertex">

attribute vec4 position;

void main(void) {
    gl_Position = position;
}

</script>

<script id="fs-shader" type="x-shader/x-fragment">

#ifdef GL_ES
precision highp float;
#endif

struct Particle
{
    vec2 pos;
    float life;
    float size;
};

uniform sampler2D tex0;
uniform float time;
uniform vec2 resolution;
uniform Particle particles[128];
uniform vec2 lightDirection;

float calculateInfluence(Particle p, vec2 coord, out vec2 normal)
{
    vec2 dv = p.pos-coord;
    float d = length(dv);
    normal = dv/d;

    float r = 15.*(1.-p.life)*p.size;
    float theta = d*d/(6.*r);
    float ratio = d/r;

    float thetaOffset = 1.6 + 7.*p.life*ratio;
    float fade = (1.-ratio)*p.life;
    return d < r ? cos(theta+thetaOffset)*fade : 0.;
}

vec4 dodge(vec4 bottom, vec4 top)
{
    return vec4(bottom.xyz/(vec3(1.)-top.xyz),1.);
}

void main(void)
{
    vec2 coord = vec2(gl_FragCoord.x,resolution.y-gl_FragCoord.y);
    vec2 uv = coord/resolution;

    vec3 color = vec3(0.);
    float light = 0.;
    for (int i = 0; i < 32; i++) {
        Particle particle = particles[i];
        if (particle.life > 0.) {
            vec2 normal;
            float f = calculateInfluence(particle, coord, normal);
            uv += .06*normal*f;
            light += clamp(f*(normal.x*lightDirection.x+normal.y*lightDirection.y),0.,.6);
        }
    }

    vec4 texColor = texture2D(tex0,uv);
    gl_FragColor = dodge(vec4(texColor.xyz,1.),vec4(clamp(light,0.,1.)));
}

</script>

<script type="text/javascript">

    window.timotuominen = { webgl: {} };

    timotuominen.webgl.FromScratchDemo = function (options) {
        var particleRenderer = new timotuominen.webgl.PlainShader(options);
        var render = particleRenderer.render;
        var prepareShader = particleRenderer.prepareShader;

        var NUM_MAX_PARTICLES = 128;
        var particles = new Array(NUM_MAX_PARTICLES);

        function updateParticles () {
            for (var i = 0; i < NUM_MAX_PARTICLES; i++) {
                if (particles[i]) {
                    var p = particles[i];
                    if (p.life > 0) {
                        p.life -= .01;
                        if (p.life <= .01) {
                            p.life = 0;
                        }
                    } else {
                        particles[i] = null;
                    }
                }
            }
        }

        function addParticle (particle) {
            for (var i = 0; i < NUM_MAX_PARTICLES; i++) {
                if (!particles[i]) {
                    particles[i] = particle;
                    return;
                }
            }
        }

        particleRenderer.render = function () {
            if (Math.random() < .1) {
                addParticle({
                    life: 1.,
                    x: Math.random()*this.viewportWidth,
                    y: Math.random()*this.viewportHeight,
                    size: 40.+Math.random()*60.
                });
            }
            updateParticles();
            render.apply(this);
        };

        particleRenderer.prepareShader = function () {
            prepareShader.apply(this);
            this.gl.uniform2f(this.getUni("lightDirection"), Math.sqrt(2), Math.sqrt(2));
            for (var i = 0; i < NUM_MAX_PARTICLES; i++) {
                if (particles[i]) {
                    var p = particles[i];
                    this.gl.uniform2f(this.getUni("particles["+i+"].pos"), p.x, p.y);
                    this.gl.uniform1f(this.getUni("particles["+i+"].life"), p.life);
                    this.gl.uniform1f(this.getUni("particles["+i+"].size"), p.size);
                }
            }
        };

        return particleRenderer;
    };

</script>

<script src="plainShader.js"></script>
<script src="canvasInitialize.js"></script>
<script src="webglUtils.js"></script>

</head>
<body>
    <a href="../explain.html#particle_ripple" style="position:fixed;background:white;top:0;right:0;text-decoration:none;color:black;padding:5px 7px;border-bottom:2px solid black;border-left:2px solid black;">Show formatted source</a>
</body>
</html>